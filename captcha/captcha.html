<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Captcha Says</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <style type="text/css">
    html,
    body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
    }
    
    #captcha-container {
      background: white;
      width: 390px;
      height: 300px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    
    body {
      margin: 0;
      font-family: 'Arial', sans-serif;
    }
    
    .game-title {
      font-size: 3em;
      margin-bottom: 20px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }
    
    .captcha-title {
      font-size: 1.5em;
      margin-bottom: 10px;
      opacity: 0.9;
    }
    
    .game-info {
      display: flex;
      justify-content: center;
      width: 300px;
      margin-bottom: 30px;
      font-size: 1.2em;
    }
    
    .simon-board {
      position: relative;
      width: 250px;
      height: 250px;
      border-radius: 50%;
      background: #2c3e50;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      transition: none;
    }
    
    .piece {
      position: absolute;
      width: 118px;
      height: 118px;
      cursor: pointer;
      border: 2px solid #2c3e50;
      transition: all 0.15s ease;
      user-select: none;
      transform-origin: center;
    }
    
    .piece:hover {
      filter: brightness(1.2);
    }
    
    .piece.active {
      filter: brightness(1.5);
      transform: scale(1.1);
    }
    
    .piece.clicked {
      transform: scale(0.95);
      filter: brightness(0.8);
    }
    
    .piece.red {
      background: #e74c3c;
      top: 3px;
      right: 3px;
      border-top-right-radius: 100%;
    }
    
    .piece.blue {
      background: #3498db;
      top: 3px;
      left: 3px;
      border-top-left-radius: 100%;
    }
    
    .piece.green {
      background: #2ecc71;
      bottom: 3px;
      left: 3px;
      border-bottom-left-radius: 100%;
    }
    
    .piece.yellow {
      background: #f1c40f;
      bottom: 3px;
      right: 3px;
      border-bottom-right-radius: 100%;
    }
    
    .center-circle {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90px;
      height: 90px;
      background: #34495e;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2em;
      font-weight: bold;
      color: white;
      box-shadow: inset 0 2px 10px rgba(0,0,0,0.3);
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .center-circle:hover {
      background: #3d566e;
    }
    
    .center-circle.disabled {
      cursor: not-allowed;
    }
    
    .center-circle.success {
      background: #2ecc71 !important;
      animation: successPulse 0.5s ease-in-out;
      transform: translate(-50%, -50%);
    }
    
    @keyframes successPulse {
      0% { 
        transform: translate(-50%, -50%) scale(1);
        box-shadow: inset 0 2px 10px rgba(0,0,0,0.3), 0 0 0 0 rgba(46, 204, 113, 0.7);
      }
      50% { 
        transform: translate(-50%, -50%) scale(1.2);
        box-shadow: inset 0 2px 10px rgba(0,0,0,0.3), 0 0 0 20px rgba(46, 204, 113, 0);
      }
      100% { 
        transform: translate(-50%, -50%) scale(1);
        box-shadow: inset 0 2px 10px rgba(0,0,0,0.3), 0 0 0 0 rgba(46, 204, 113, 0);
      }
    }
    
    .center-circle.fail {
      background: #e74c3c !important;
      animation: failShake 0.6s ease-in-out;
    }
    
    @keyframes failShake {
      0%, 100% { 
        transform: translate(-50%, -50%);
      }
      10%, 30%, 50%, 70%, 90% { 
        transform: translate(-55%, -50%);
      }
      20%, 40%, 60%, 80% { 
        transform: translate(-45%, -50%);
      }
    }
    
    .controls {
      display: flex;
      gap: 20px;
      margin-top: 20px;
    }
    
    .btn {
      padding: 12px 24px;
      font-size: 1.1em;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: bold;
    }
    
    .btn-start {
      background: #2ecc71;
      color: white;
    }
    
    .btn-start:hover {
      background: #27ae60;
      transform: translateY(-2px);
    }
    
    .btn-reset {
      background: #e74c3c;
      color: white;
    }
    
    .btn-reset:hover {
      background: #c0392b;
      transform: translateY(-2px);
    }
    
    .message {
      margin-top: 20px;
      font-size: 1.3em;
      min-height: 30px;
      font-weight: bold;
    }
    
    .game-over {
      background: rgba(231, 76, 60, 0.9);
      color: white;
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
    }
  </style>
</head>

<body>
  <div id="captcha-container">
    <div class="simon-board">
      <div class="piece red" data-color="red"></div>
      <div class="piece blue" data-color="blue"></div>
      <div class="piece green" data-color="green"></div>
      <div class="piece yellow" data-color="yellow"></div>
      <div class="center-circle" id="centerBtn">
        <span id="center-text">START</span>
      </div>
    </div>
  </div>
  
  <script type="text/javascript">
    class SimonGame {
      constructor() {
        this.sequence = [];
        this.playerSequence = [];
        this.level = 1;
        this.isPlaying = false;
        this.isPlayerTurn = false;
        this.gameComplete = false;
        this.maxLevel = 7;
        this.baseDelay = 600;
        this.baseSpinSpeed = 15;
        this.rotationAngle = 0;
        this.spinInterval = null;
        
        this.colors = ['red', 'blue', 'green', 'yellow'];
        this.sounds = this.createSounds();
        
        this.init();
      }
      
      init() {
        this.pieces = document.querySelectorAll('.piece');
        this.centerBtn = document.getElementById('centerBtn');
        this.centerText = document.getElementById('center-text');
        this.board = document.querySelector('.simon-board');
        
        this.bindEvents();
      }
      
      createSounds() {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const frequencies = { red: 440, blue: 523, green: 659, yellow: 784 };
        
        return {
          play: (color) => {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(frequencies[color], audioContext.currentTime);
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
          }
        };
      }
      
      bindEvents() {
        this.centerBtn.addEventListener('click', () => this.handleCenterClick());
        
        this.pieces.forEach(piece => {
          piece.addEventListener('click', (e) => this.handlePieceClick(e));
        });
      }
      
      handleCenterClick() {
        if (!this.isPlaying) {
          this.startGame();
        } else if (this.gameComplete) {
          this.resetGame();
        }
      }
      
      startGame() {
        this.isPlaying = true;
        this.gameComplete = false;
        this.centerBtn.classList.add('disabled');
        this.centerText.textContent = `${this.level}/${this.maxLevel}`;
        
        this.addToSequence();
        this.playSequence();
      }
      
      addToSequence() {
        const randomColor = this.colors[Math.floor(Math.random() * this.colors.length)];
        this.sequence.push(randomColor);
      }
      
      async playSequence() {
        this.isPlayerTurn = false;
        
        // Update spinning after level 4
        if (this.level >= 4) {
          const spinSpeed = Math.max(this.baseSpinSpeed - (this.level - 4) * 1, 1);
          
          if (!this.spinInterval) {
            this.startSpinning(spinSpeed);
          } else {
            this.updateSpinSpeed(spinSpeed);
          }
        }
        
        // Calculate delay
        const currentDelay = Math.max(this.baseDelay - (this.level - 1) * 150, 150);
        
        for (let i = 0; i < this.sequence.length; i++) {
          await this.delay(currentDelay);
          await this.activatePiece(this.sequence[i]);
        }
        
        this.isPlayerTurn = true;
      }
      
      startSpinning(speed) {
        if (this.spinInterval) {
          clearInterval(this.spinInterval);
        }
        
        const degreesPerSecond = 360 / speed; // degrees per second
        const degreesPerFrame = degreesPerSecond / 60; // degrees per frame at 60fps
        
        this.spinInterval = setInterval(() => {
          this.rotationAngle = (this.rotationAngle + degreesPerFrame) % 360;
          this.board.style.transform = `rotate(${this.rotationAngle}deg)`;
        }, 1000/60); // 60fps
      }

      stopSpinning() {
        if (this.spinInterval) {
          clearInterval(this.spinInterval);
          this.spinInterval = null;
        }
        this.board.style.transform = 'rotate(0deg)';
        this.rotationAngle = 0;
      }
      
      updateSpinSpeed(speed) {
        if (this.spinInterval) {
          clearInterval(this.spinInterval);
          
          const degreesPerSecond = 360 / speed;
          const degreesPerFrame = degreesPerSecond / 60;
          
          this.spinInterval = setInterval(() => {
            this.rotationAngle = (this.rotationAngle + degreesPerFrame) % 360;
            this.board.style.transform = `rotate(${this.rotationAngle}deg)`;
          }, 1000/60);
        }
      }
      
      async activatePiece(color) {
        const piece = document.querySelector(`[data-color="${color}"]`);
        piece.classList.add('active');
        this.sounds.play(color);
        
        await this.delay(400);
        piece.classList.remove('active');
      }
      
      handlePieceClick(e) {
        if (!this.isPlayerTurn || !this.isPlaying) return;
        
        const piece = e.target;
        const clickedColor = piece.dataset.color;
        
        this.isPlayerTurn = false;
        
        piece.classList.add('clicked');
        setTimeout(() => piece.classList.remove('clicked'), 150);
        
        this.sounds.play(clickedColor);
        this.playerSequence.push(clickedColor);
        
        const currentIndex = this.playerSequence.length - 1;
        if (this.playerSequence[currentIndex] !== this.sequence[currentIndex]) {
          this.gameOver();
          return;
        }
        
        if (this.playerSequence.length === this.sequence.length) {
          this.playerSequence = [];
          
          if (this.level >= this.maxLevel) {
            this.gameWon();
          } else {
            this.levelUp();
          }
        } else {
          setTimeout(() => {
            if (this.isPlaying && !this.gameComplete) {
              this.isPlayerTurn = true;
            }
          }, 200);
        }
      }
      
      async levelUp() {
        this.centerBtn.classList.add('success');
        await this.delay(800);
        this.centerBtn.classList.remove('success');
        
        this.level++;
        this.centerText.textContent = `${this.level}/${this.maxLevel}`;
        
        // Handle spinning when reaching level 4
        if (this.level >= 4) {
          const spinSpeed = Math.max(this.baseSpinSpeed - (this.level - 4) * 2, 1); // Change from * 1 to * 2
          
          if (!this.spinInterval) {
            this.startSpinning(spinSpeed);
          } else {
            this.updateSpinSpeed(spinSpeed);
          }
        }
        
        await this.delay(700);
        this.addToSequence();
        this.playSequence();
      }
      
      resetGame() {
        this.centerBtn.classList.remove('success', 'fail');
        this.stopSpinning(); // Add this line
        
        this.sequence = [];
        this.playerSequence = [];
        this.level = 1;
        this.isPlaying = false;
        this.isPlayerTurn = false;
        this.gameComplete = false;
        
        this.centerText.textContent = 'START';
        this.centerBtn.classList.remove('disabled');
        
        this.pieces.forEach(piece => {
          piece.classList.remove('active');
          piece.classList.remove('clicked');
        });
      }
      
      async gameOver() {
        this.isPlaying = false;
        this.isPlayerTurn = false;
        this.gameComplete = true;
        this.stopSpinning(); // Add this line
        
        this.centerBtn.classList.add('fail');
        this.centerText.textContent = 'FAIL';
        
        await this.delay(600);
        this.centerBtn.classList.remove('fail');
        
        this.sequence = [];
        this.playerSequence = [];
        this.level = 1;
        this.gameComplete = false;
        
        this.centerBtn.classList.remove('disabled');
        this.centerText.textContent = 'RETRY';
      }
      
      async gameWon() {
        this.isPlaying = false;
        this.isPlayerTurn = false;
        this.gameComplete = true;
        this.stopSpinning();
        
        this.centerText.textContent = 'Done!';
        
        await this.delay(1500);
        captchaSuccess()
      }
      
      delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
      }
    }
    
    document.addEventListener('DOMContentLoaded', () => {
      new SimonGame();
    });
    
    function captchaSuccess() {
      window.top.postMessage("success", '*');
    }
  </script>
</body>
</html>
